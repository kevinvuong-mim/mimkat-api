# Google OAuth API Documentation

## Overview

API xác thực người dùng thông qua Google OAuth 2.0. Hỗ trợ cả Bearer tokens và HttpOnly cookies.

**Base URL**: `/auth`

**OAuth Flow**: Authorization Code Flow with PKCE

**Cookie Configuration**:

- `accessToken`: HttpOnly, Secure (production), SameSite=strict, Expires 1h
- `refreshToken`: HttpOnly, Secure (production), SameSite=strict, Expires 7d

---

## Endpoints

### 1. Initiate Google OAuth (Bắt đầu đăng nhập Google)

Khởi tạo quá trình đăng nhập Google OAuth. Endpoint này sẽ redirect người dùng đến trang đăng nhập của Google.

**Endpoint**: `GET /auth/google`

**Authentication**: Không yêu cầu (Public)

#### Response

Endpoint này sẽ redirect người dùng đến Google OAuth consent screen. Không có JSON response.

#### Redirect Flow

1. User truy cập `/auth/google`
2. Backend redirect đến `https://accounts.google.com/o/oauth2/v2/auth` với các parameters:
   - `client_id`: Google OAuth Client ID
   - `redirect_uri`: `{BACKEND_URL}/auth/google/callback`
   - `response_type`: `code`
   - `scope`: `email profile`
3. User chọn tài khoản Google và cấp quyền
4. Google redirect về `/auth/google/callback` với authorization code

---

### 2. Google OAuth Callback (Xử lý callback từ Google)

Xử lý callback từ Google sau khi user cấp quyền. Tự động set cookies và redirect về frontend.

**Endpoint**: `GET /auth/google/callback`

**Authentication**: Không yêu cầu (Public - handled by Google)

#### Query Parameters (Auto-generated by Google)

| Parameter | Type   | Description                  |
| --------- | ------ | ---------------------------- |
| code      | string | Authorization code từ Google |
| scope     | string | Các scopes đã được cấp quyền |

#### Response

**Success (302 Redirect)**

Backend sẽ:

1. Set HttpOnly cookies với accessToken và refreshToken
2. Redirect về frontend với success status

```
{FRONTEND_URL}/auth/callback?success=true
```

**Response Headers (Set-Cookie)**:

```
Set-Cookie: accessToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict; Max-Age=3600
Set-Cookie: refreshToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict; Max-Age=604800
```

**Error Responses**

- **401 Unauthorized**: Google authentication failed

```json
{
  "success": false,
  "statusCode": 401,
  "message": "Google authentication failed",
  "error": "Unauthorized",
  "timestamp": "2025-11-12T10:00:00.000Z",
  "path": "/auth/google/callback"
}
```

- **401 Unauthorized**: Account bị vô hiệu hóa

```json
{
  "success": false,
  "statusCode": 401,
  "message": "Account has been disabled",
  "error": "Unauthorized",
  "timestamp": "2025-11-12T10:00:00.000Z",
  "path": "/auth/google/callback"
}
```

## Authentication Methods

### Method 1: Cookies (Web Apps)

```javascript
// After successful OAuth, cookies are automatically set
// Use credentials: 'include' for all subsequent requests
fetch('/api/protected', {
  credentials: 'include',
})
  .then((response) => response.json())
  .then((data) => console.log(data));
```

### Method 2: Manual Token Handling

```javascript
// For mobile apps or if tokens needed in localStorage
// (Requires backend modification to return authData)
const urlParams = new URLSearchParams(window.location.search);
const authData = urlParams.get('authData');

if (authData) {
  const decoded = JSON.parse(atob(authData));
  localStorage.setItem('accessToken', decoded.data.accessToken);
  localStorage.setItem('refreshToken', decoded.data.refreshToken);
}
```

---

## Google OAuth User Data

### Data từ Google

Backend nhận được từ Google Profile API:

```json
{
  "googleId": "1234567890",
  "email": "user@gmail.com",
  "firstName": "John",
  "lastName": "Doe",
  "avatar": "https://lh3.googleusercontent.com/a/..."
}
```

### Lưu trữ trong Database

```typescript
{
  id: string; // Generated UUID
  email: string; // From Google
  googleId: string; // Google User ID
  fullName: string; // "${firstName} ${lastName}"
  avatar: string | null; // Google avatar URL
  password: null; // No password for pure OAuth users
  isEmailVerified: true; // Auto-verified for Google users
  isActive: true; // Default active
  createdAt: Date;
  updatedAt: Date;
}
```

---

## Account Linking Scenarios

### 1. New User (First Time Login)

**Scenario**: User chưa có tài khoản trong hệ thống

**Flow**:

1. Tạo user mới với Google authentication
2. `isEmailVerified: true` (Google đã verify)
3. Tạo session và tokens
4. Redirect với auth data

---

### 2. Existing Google User

**Scenario**: User đã đăng nhập bằng Google trước đây

**Flow**:

1. Tìm user bằng `googleId`
2. Update thông tin nếu có thay đổi (fullName, avatar)
3. Tạo session và tokens mới
4. Redirect với auth data

---

### 3. Existing Local User (Email Match)

**Scenario**: User đã đăng ký bằng email/password, sau đó dùng Google login với cùng email

**Conditions**:

- Email đã được verify
- Chưa có `googleId`

**Flow**:

1. Link Google account với user hiện có
2. Update: `googleId`, `avatar` (giữ nguyên `password` để có thể login cả 2 cách)
3. Xóa password cũ (convert sang Google account)
4. Tạo session và tokens
5. Redirect với auth data

---

### 4. Unverified Local User (Spam Prevention)

**Scenario**: Có tài khoản với password chưa verify email (có thể là spam registration)

**Conditions**:

- `isEmailVerified: false`
- Chưa có `googleId`

**Flow**:

1. Xóa tài khoản chưa verify email
2. Tạo tài khoản Google mới
3. Tạo session và tokens
4. Redirect với auth data

**Rationale**: Ngăn spam registration chiếm email

---

## Security Features

### Token Security

- **No password**: OAuth users không có password trong database
- **Email verified**: Luôn `isEmailVerified: true`
- **Account linking**: Tự động link với tài khoản hiện có (nếu email match và đã verify)
- **Spam prevention**: Xóa tài khoản chưa verify email khi Google login

### Session Management

- Áp dụng device limit như password auth
- Hỗ trợ multi-device login
- Token rotation khi refresh

### Data Protection

- AuthData được encode base64 trong URL (not encrypted - chỉ là obfuscation)
- Frontend phải lưu tokens ngay và clear URL
- Không lưu sensitive data trong URL lâu hơn cần thiết

---

## Common Errors

### Invalid Client ID

**Error**: `redirect_uri_mismatch`

**Cause**: Redirect URI không match với Google Console config

**Solution**: Kiểm tra lại `GOOGLE_CALLBACK_URL` và Google Console settings

### User Cancelled

**Scenario**: User từ chối cấp quyền trên Google consent screen

**Solution**: User sẽ được redirect về trang login, không có authData

### Account Disabled

**Response**:

```json
{
  "success": false,
  "statusCode": 401,
  "message": "Account has been disabled",
  "error": "Unauthorized",
  "timestamp": "2025-11-12T10:00:00.000Z",
  "path": "/auth/google/callback"
}
```

**Solution**: Contact admin để kích hoạt lại tài khoản
