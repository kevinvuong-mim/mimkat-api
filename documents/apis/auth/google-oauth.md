# Google OAuth API Documentation

## Overview

API xác thực người dùng thông qua Google OAuth 2.0. Cho phép người dùng đăng nhập nhanh chóng bằng tài khoản Google của họ mà không cần tạo password riêng.

**Base URL**: `/auth`

**OAuth Flow**: Authorization Code Flow (Passport Google OAuth 2.0)

**Security Features**:

- Tự động verify email (Google accounts đã được verified)
- Hỗ trợ link Google account vào tài khoản email/password hiện có
- Session management với device tracking
- HttpOnly cookies với SameSite=Lax
- Maximum 5 concurrent sessions per user

---

## Endpoints

### 1. Initiate Google OAuth (Bắt đầu đăng nhập Google)

Khởi tạo quá trình đăng nhập Google OAuth. Endpoint này sẽ redirect người dùng đến trang đăng nhập của Google.

**Endpoint**: `GET /auth/google`

**Authentication**: Không yêu cầu (Public)

**Rate Limit**: Không giới hạn

#### Request

```bash
GET /auth/google
```

Không cần request body hay parameters. Browser sẽ tự động redirect.

#### Response

Endpoint này sẽ redirect người dùng đến Google OAuth consent screen. Không có JSON response.

#### Redirect Flow

1. User truy cập `/auth/google` (hoặc click "Login with Google" button)
2. GoogleAuthGuard (Passport strategy) xử lý request
3. Backend redirect đến `https://accounts.google.com/o/oauth2/v2/auth` với các parameters:
   - `client_id`: Google OAuth Client ID (từ env GOOGLE_CLIENT_ID)
   - `redirect_uri`: `{GOOGLE_CALLBACK_URL}` (env variable)
   - `response_type`: `code`
   - `scope`: `email profile`
   - `access_type`: `offline` (optional)
4. User chọn tài khoản Google và cấp quyền
5. Google redirect về `/auth/google/callback?code={authorization_code}`

#### Notes

- Sử dụng Passport Google OAuth 2.0 Strategy
- Strategy name: `'google'`
- Scope được request: `['email', 'profile']`

---

### 2. Google OAuth Callback (Xử lý callback từ Google)

Xử lý callback từ Google sau khi user cấp quyền. Tự động tạo/link account, set cookies và redirect về frontend với tokens.

**Endpoint**: `GET /auth/google/callback`

**Authentication**: Không yêu cầu (Public - handled by GoogleAuthGuard)

**Rate Limit**: Không giới hạn

#### Query Parameters (Auto-generated by Google)

| Parameter | Type   | Required | Description                     |
| --------- | ------ | -------- | ------------------------------- |
| code      | string | Yes      | Authorization code từ Google    |
| scope     | string | Yes      | Các scopes đã được cấp quyền    |
| state     | string | No       | CSRF protection (if configured) |

#### Processing Flow

1. GoogleAuthGuard intercepts request
2. Exchange authorization code for access token with Google
3. Fetch user profile from Google (id, email, name, photo)
4. GoogleStrategy validates and returns user data:
   ```typescript
   {
     googleId: string,      // Google user ID
     email: string,         // User's email
     firstName: string,     // Given name
     lastName: string,      // Family name
     avatar: string,        // Profile picture URL
     accessToken: string,   // Google access token
     refreshToken?: string  // Google refresh token (if available)
   }
   ```
5. AuthService.googleLogin() processes user:
   - Check if user exists (by googleId or email)
   - Create new user OR link Google to existing user
   - Create session first to get session ID
   - Generate JWT tokens with session ID embedded
   - Update session with refresh token
6. Set HttpOnly cookies
7. Encode tokens as base64
8. Redirect to frontend with authData

**JWT Tokens**: Both access and refresh tokens contain `sessionId` in payload for session tracking

#### Response

**Success (302 Redirect)**

Backend sẽ:

1. Set HttpOnly cookies với accessToken và refreshToken
2. Redirect về frontend

**Note**: Tokens được lưu trữ an toàn trong HttpOnly cookies, không cần truyền qua URL nữa.

**Response Headers (Set-Cookie)**:

```
Set-Cookie: accessToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Lax; Max-Age=3600; Path=/
Set-Cookie: refreshToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Lax; Max-Age=604800; Path=/
```

**Cookie Configuration**:

- `HttpOnly`: true (không thể access bằng JavaScript)
- `Secure`: true trong production (NODE_ENV=production)
- `SameSite`: lax (CSRF protection)
- `MaxAge`: 3600s (1 hour) cho accessToken, 604800s (7 days) cho refreshToken
- `Path`: / (available cho tất cả routes)

**Error Responses**

- **400 Bad Request**: Google authentication failed

```json
{
  "success": false,
  "statusCode": 400,
  "message": "No user from Google",
  "error": "Bad Request",
  "timestamp": "2025-11-12T10:00:00.000Z",
  "path": "/auth/google/callback"
}
```

- **401 Unauthorized**: Account bị vô hiệu hóa

```json
{
  "success": false,
  "statusCode": 401,
  "message": "Account has been disabled",
  "error": "Unauthorized",
  "timestamp": "2025-11-12T10:00:00.000Z",
  "path": "/auth/google/callback"
}
```

---

## Google OAuth Flow Details

### 1. User Scenarios

#### Scenario A: New User (First Time Login)

**Điều kiện**: Không có user nào với googleId hoặc email này

**Backend xử lý**:

1. Tạo user mới trong database
2. Set các fields:
   ```typescript
   {
     email: googleUser.email,
     googleId: googleUser.googleId,
     fullName: `${googleUser.firstName} ${googleUser.lastName}`,
     avatar: googleUser.avatar,
     password: null,                    // Không có password
     isEmailVerified: true,             // Google đã verify
     isActive: true                     // Default active
   }
   ```
3. Generate JWT access token (1h) và refresh token (7d)
4. Create session với device info
5. Set HttpOnly cookies
6. Redirect to frontend

**Kết quả**: User mới được tạo và có thể login bằng Google

#### Scenario B: Existing Email User (Link Google)

**Điều kiện**: Có user với email này nhưng `googleId = null`

**Backend xử lý**:

1. Tìm user hiện tại bằng email
2. Update user với Google info:
   ```typescript
   {
     googleId: googleUser.googleId,           // Link Google account
     avatar: user.avatar || googleUser.avatar, // Update nếu chưa có
     fullName: user.fullName || `${googleUser.firstName} ${googleUser.lastName}`,
     isEmailVerified: true                     // Đảm bảo verified
   }
   ```
3. Generate JWT tokens
4. Create session
5. Set cookies và redirect to frontend

**Kết quả**: User có thể login bằng CẢ email/password VÀ Google

**Ví dụ**:

- User đăng ký với email `john@example.com` + password
- Sau đó login bằng Google với cùng email `john@example.com`
- Hệ thống tự động link Google vào account hiện có
- User giờ có 2 cách login: email/password hoặc Google

#### Scenario C: Returning Google User

**Điều kiện**: Đã có user với `googleId` này

**Backend xử lý**:

1. Tìm user bằng `googleId`
2. Check `isActive = true`
3. Generate JWT tokens
4. Create session
5. Set cookies và redirect to frontend

**Kết quả**: User login thành công như bình thường

### 2. Session Management

- **Session Creation**: Mỗi lần Google login tạo session mới
- **Device Info**: Tự động capture từ request headers
  - Device name (từ User-Agent)
  - Device type (Desktop/Mobile/Tablet)
  - IP address
  - Full User-Agent string
- **Session Limit**: Maximum 5 concurrent sessions per user
- **Cleanup**: Session cũ nhất (theo `lastUsedAt`) bị xóa khi vượt limit
- **Token Expiry**:
  - Access token: 1 hour
  - Refresh token: 7 days
- **Session Fields**:
  ```typescript
  {
    refreshToken: string,
    userId: string,
    expiresAt: Date,
    deviceName: string,
    deviceType: string,
    ipAddress: string,
    userAgent: string,
    lastUsedAt: Date,
    createdAt: Date
  }
  ```

---

## Common Errors

### Invalid Client ID

**Error**: `redirect_uri_mismatch`

**Response from Google**:

```
Error 400: redirect_uri_mismatch
The redirect URI in the request, http://localhost:3000/auth/google/callback,
does not match the ones authorized for the OAuth client.
```

**Causes**:

- Redirect URI không match với Google Console config
- Thiếu protocol (http:// hoặc https://)
- Port number không match
- Trailing slash difference (có/không có `/` cuối URL)

**Solutions**:

1. Kiểm tra `GOOGLE_CALLBACK_URL` trong .env file
2. Verify Authorized Redirect URIs trong Google Console
3. Đảm bảo URLs match **chính xác** (bao gồm protocol, domain, port)
4. Clear browser cache và retry

### User Cancelled

**Scenario**: User từ chối cấp quyền trên Google consent screen

**Result**:

- User bị redirect về một error page hoặc không redirect về app
- Cookies không được set

**Solution**:

- Hiển thị message "Login cancelled" cho user
- Provide "Try Again" button để retry Google login
- Redirect về login page

### Account Disabled

**Response**:

```json
{
  "success": false,
  "statusCode": 401,
  "message": "Account has been disabled",
  "error": "Unauthorized",
  "timestamp": "2025-11-12T10:00:00.000Z",
  "path": "/auth/google/callback"
}
```

**Solution**: Contact admin để kích hoạt lại tài khoản

### "No user from Google"

**Error Response**:

```json
{
  "success": false,
  "statusCode": 400,
  "message": "No user from Google",
  "error": "Bad Request",
  "timestamp": "2025-11-12T10:00:00.000Z",
  "path": "/auth/google/callback"
}
```

**Causes**:

- Google không trả về user profile
- Google access token invalid
- Network error khi fetch profile từ Google
- Passport strategy configuration sai

**Solutions**:

1. Check Google OAuth credentials (CLIENT_ID, CLIENT_SECRET)
2. Verify Google+ API được enable
3. Check network connectivity
4. Review Passport strategy configuration
5. Check console logs cho error details

### Invalid Scopes

**Error**: User thấy warning về permissions không được recognize

**Cause**: Scope không hợp lệ hoặc không được Google support

**Solution**:

- Sử dụng chỉ scopes standard: `['email', 'profile']`
- Không thêm custom scopes không cần thiết
- Review Google OAuth scopes documentation

---

## Troubleshooting Checklist

- [ ] Google Client ID và Secret đúng
- [ ] Redirect URI match chính xác trong Google Console
- [ ] Google+ API được enable
- [ ] CORS_ORIGIN được set đúng
- [ ] NODE_ENV được set (development/production)
- [ ] JWT secrets được configure
- [ ] Database connection working
- [ ] Frontend có thể đọc HttpOnly cookies để xác định trạng thái đăng nhập
- [ ] Browser cookies enabled
- [ ] No ad blockers blocking OAuth flow
- [ ] Network connection stable

---

## Related Documentation

- [Authentication API](./authentication.md) - Email/password authentication
- [Session Management API](../users/session-management.md) - Manage active sessions
- [User Profile API](../users/user-profile.md) - Get user information

---

## Support

Nếu gặp vấn đề với Google OAuth:

1. Check server logs cho error details
2. Verify Google Cloud Console configuration
3. Test với different Google account
4. Check browser console cho JavaScript errors
5. Review network tab cho failed requests
