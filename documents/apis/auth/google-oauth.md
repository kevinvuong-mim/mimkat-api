# Google OAuth API Documentation

## Overview

API xác thực người dùng thông qua Google OAuth 2.0. Hỗ trợ đăng ký mới và liên kết tài khoản hiện có.

**Base URL**: `/auth`

**OAuth Flow**: Authorization Code Flow with PKCE

---

## Endpoints

### 1. Initiate Google OAuth (Bắt đầu đăng nhập Google)

Khởi tạo quá trình đăng nhập Google OAuth. Endpoint này sẽ redirect người dùng đến trang đăng nhập của Google.

**Endpoint**: `GET /auth/google`

**Authentication**: Không yêu cầu (Public)

#### Response

Endpoint này sẽ redirect người dùng đến Google OAuth consent screen. Không có JSON response.

#### Redirect Flow

1. User truy cập `/auth/google`
2. Backend redirect đến `https://accounts.google.com/o/oauth2/v2/auth` với các parameters:
   - `client_id`: Google OAuth Client ID
   - `redirect_uri`: `{BACKEND_URL}/auth/google/callback`
   - `response_type`: `code`
   - `scope`: `email profile`
3. User chọn tài khoản Google và cấp quyền
4. Google redirect về `/auth/google/callback` với authorization code

#### Frontend Integration

```typescript
// Redirect user to Google OAuth
window.location.href = 'http://localhost:3000/auth/google';
```

---

### 2. Google OAuth Callback (Xử lý callback từ Google)

Xử lý callback từ Google sau khi user cấp quyền. Google sẽ tự động redirect đến endpoint này với authorization code.

**Endpoint**: `GET /auth/google/callback`

**Authentication**: Không yêu cầu (Public - handled by Google)

#### Query Parameters (Auto-generated by Google)

| Parameter | Type   | Description                  |
| --------- | ------ | ---------------------------- |
| code      | string | Authorization code từ Google |
| scope     | string | Các scopes đã được cấp quyền |

#### Response

**Success (302 Redirect)**

Backend sẽ redirect về frontend với authentication data encoded trong URL:

```
{FRONTEND_URL}/auth/callback?authData={BASE64_ENCODED_DATA}
```

**Decoded authData**:

```json
{
  "message": "Google login successful",
  "user": {
    "id": "clx1234567890abcdefghij",
    "email": "user@gmail.com",
    "fullName": "John Doe",
    "avatar": "https://lh3.googleusercontent.com/..."
  },
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expiresIn": 3600
}
```

| Field         | Type   | Description                               |
| ------------- | ------ | ----------------------------------------- |
| message       | string | Thông báo đăng nhập thành công            |
| user          | object | Thông tin người dùng                      |
| user.id       | string | User ID trong hệ thống                    |
| user.email    | string | Email từ Google account                   |
| user.fullName | string | Tên đầy đủ từ Google profile              |
| user.avatar   | string | URL avatar từ Google                      |
| accessToken   | string | JWT access token để xác thực API requests |
| refreshToken  | string | Refresh token để làm mới access token     |
| expiresIn     | number | Thời gian hết hạn của accessToken (giây)  |

**Error Responses**

- **401 Unauthorized**: Google authentication failed

```json
{
  "statusCode": 401,
  "message": "Google authentication failed",
  "error": "Unauthorized"
}
```

- **401 Unauthorized**: Account bị vô hiệu hóa

```json
{
  "statusCode": 401,
  "message": "Account has been disabled",
  "error": "Unauthorized"
}
```

---

## Google OAuth User Data

### Data từ Google

Backend nhận được từ Google Profile API:

```json
{
  "googleId": "1234567890",
  "email": "user@gmail.com",
  "firstName": "John",
  "lastName": "Doe",
  "avatar": "https://lh3.googleusercontent.com/a/..."
}
```

### Lưu trữ trong Database

```typescript
{
  id: string; // Generated UUID
  email: string; // From Google
  googleId: string; // Google User ID
  fullName: string; // "${firstName} ${lastName}"
  avatar: string | null; // Google avatar URL
  password: null; // No password for pure OAuth users
  isEmailVerified: true; // Auto-verified for Google users
  isActive: true; // Default active
  createdAt: Date;
  updatedAt: Date;
}
```

---

## Account Linking Scenarios

### 1. New User (First Time Login)

**Scenario**: User chưa có tài khoản trong hệ thống

**Flow**:

1. Tạo user mới với Google authentication
2. `isEmailVerified: true` (Google đã verify)
3. Tạo session và tokens
4. Redirect với auth data

---

### 2. Existing Google User

**Scenario**: User đã đăng nhập bằng Google trước đây

**Flow**:

1. Tìm user bằng `googleId`
2. Update thông tin nếu có thay đổi (fullName, avatar)
3. Tạo session và tokens mới
4. Redirect với auth data

---

### 3. Existing Local User (Email Match)

**Scenario**: User đã đăng ký bằng email/password, sau đó dùng Google login với cùng email

**Conditions**:

- Email đã được verify
- Chưa có `googleId`

**Flow**:

1. Link Google account với user hiện có
2. Update: `googleId`, `avatar` (giữ nguyên `password` để có thể login cả 2 cách)
3. Xóa password cũ (convert sang Google account)
4. Tạo session và tokens
5. Redirect với auth data

---

### 4. Unverified Local User (Spam Prevention)

**Scenario**: Có tài khoản với password chưa verify email (có thể là spam registration)

**Conditions**:

- `isEmailVerified: false`
- Chưa có `googleId`

**Flow**:

1. Xóa tài khoản chưa verify email
2. Tạo tài khoản Google mới
3. Tạo session và tokens
4. Redirect với auth data

**Rationale**: Ngăn spam registration chiếm email

---

## Frontend Integration

### Handle OAuth Callback

```typescript
// /auth/callback page
import { useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';

export default function AuthCallback() {
  const router = useRouter();
  const searchParams = useSearchParams();

  useEffect(() => {
    const authData = searchParams.get('authData');

    if (authData) {
      try {
        // Decode base64 auth data
        const decoded = JSON.parse(atob(authData));

        // Store tokens
        localStorage.setItem('accessToken', decoded.accessToken);
        localStorage.setItem('refreshToken', decoded.refreshToken);

        // Store user info (optional)
        localStorage.setItem('user', JSON.stringify(decoded.user));

        // Redirect to dashboard
        router.push('/dashboard');
      } catch (error) {
        console.error('Failed to process auth data:', error);
        router.push('/login?error=auth_failed');
      }
    }
  }, [searchParams, router]);

  return <div>Processing authentication...</div>;
}
```

### Google Login Button

```typescript
'use client';

export default function GoogleLoginButton() {
  const handleGoogleLogin = () => {
    // Redirect to backend Google OAuth endpoint
    window.location.href = `${process.env.NEXT_PUBLIC_API_URL}/auth/google`;
  };

  return (
    <button onClick={handleGoogleLogin}>
      <img src="/google-icon.svg" alt="Google" />
      Sign in with Google
    </button>
  );
}
```

---

## Environment Variables

### Backend (.env)

```bash
# Google OAuth
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
GOOGLE_CALLBACK_URL=http://localhost:3000/auth/google/callback

# Frontend URL for redirect after auth
FRONTEND_URL=http://localhost:3001
```

### Frontend (.env.local)

```bash
NEXT_PUBLIC_API_URL=http://localhost:3000
```

---

## Security Features

### Token Security

- **No password**: OAuth users không có password trong database
- **Email verified**: Luôn `isEmailVerified: true`
- **Account linking**: Tự động link với tài khoản hiện có (nếu email match và đã verify)
- **Spam prevention**: Xóa tài khoản chưa verify email khi Google login

### Session Management

- Áp dụng device limit như password auth
- Hỗ trợ multi-device login
- Token rotation khi refresh

### Data Protection

- AuthData được encode base64 trong URL (not encrypted - chỉ là obfuscation)
- Frontend phải lưu tokens ngay và clear URL
- Không lưu sensitive data trong URL lâu hơn cần thiết

---

## Google OAuth Setup Guide

### 1. Create Google OAuth Client

1. Truy cập [Google Cloud Console](https://console.cloud.google.com/)
2. Tạo hoặc chọn project
3. Enable Google+ API
4. Tạo OAuth 2.0 Client ID:
   - Application type: Web application
   - Authorized redirect URIs: `http://localhost:3000/auth/google/callback`

### 2. Configure Backend

File: `src/auth/strategies/google.strategy.ts`

```typescript
import { PassportStrategy } from '@nestjs/passport';
import { Strategy, VerifyCallback } from 'passport-google-oauth20';
import { Injectable } from '@nestjs/common';

@Injectable()
export class GoogleStrategy extends PassportStrategy(Strategy, 'google') {
  constructor() {
    super({
      clientID: process.env.GOOGLE_CLIENT_ID,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET,
      callbackURL: process.env.GOOGLE_CALLBACK_URL,
      scope: ['email', 'profile'],
    });
  }

  async validate(
    accessToken: string,
    refreshToken: string,
    profile: any,
    done: VerifyCallback,
  ): Promise<any> {
    const { id, name, emails, photos } = profile;

    const user = {
      googleId: id,
      email: emails[0].value,
      firstName: name.givenName,
      lastName: name.familyName,
      avatar: photos[0].value,
    };

    done(null, user);
  }
}
```

---

## Common Errors

### Invalid Client ID

**Error**: `redirect_uri_mismatch`

**Cause**: Redirect URI không match với Google Console config

**Solution**: Kiểm tra lại `GOOGLE_CALLBACK_URL` và Google Console settings

### User Cancelled

**Scenario**: User từ chối cấp quyền trên Google consent screen

**Solution**: User sẽ được redirect về trang login, không có authData

### Account Disabled

**Response**:

```json
{
  "statusCode": 401,
  "message": "Account has been disabled",
  "error": "Unauthorized"
}
```

**Solution**: Contact admin để kích hoạt lại tài khoản

---

## Related APIs

- [Authentication](./authentication.md) - Đăng ký và đăng nhập bằng email/password
- [Session Management](./session-management.md) - Quản lý phiên đăng nhập
- [User Profile](./user-profile.md) - Thông tin người dùng
