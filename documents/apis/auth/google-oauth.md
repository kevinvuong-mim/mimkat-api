# Google OAuth API Documentation

## Overview

API xác thực người dùng thông qua Google OAuth 2.0. Hỗ trợ cả Bearer tokens và HttpOnly cookies.

**Base URL**: `/auth`

**OAuth Flow**: Authorization Code Flow with PKCE

---

## Endpoints

### 1. Initiate Google OAuth (Bắt đầu đăng nhập Google)

Khởi tạo quá trình đăng nhập Google OAuth. Endpoint này sẽ redirect người dùng đến trang đăng nhập của Google.

**Endpoint**: `GET /auth/google`

**Authentication**: Không yêu cầu (Public)

#### Response

Endpoint này sẽ redirect người dùng đến Google OAuth consent screen. Không có JSON response.

#### Redirect Flow

1. User truy cập `/auth/google`
2. Backend redirect đến `https://accounts.google.com/o/oauth2/v2/auth` với các parameters:
   - `client_id`: Google OAuth Client ID
   - `redirect_uri`: `{BACKEND_URL}/auth/google/callback`
   - `response_type`: `code`
   - `scope`: `email profile`
3. User chọn tài khoản Google và cấp quyền
4. Google redirect về `/auth/google/callback` với authorization code

---

### 2. Google OAuth Callback (Xử lý callback từ Google)

Xử lý callback từ Google sau khi user cấp quyền. Tự động set cookies và redirect về frontend.

**Endpoint**: `GET /auth/google/callback`

**Authentication**: Không yêu cầu (Public - handled by Google)

#### Query Parameters (Auto-generated by Google)

| Parameter | Type   | Description                  |
| --------- | ------ | ---------------------------- |
| code      | string | Authorization code từ Google |
| scope     | string | Các scopes đã được cấp quyền |

#### Response

**Success (302 Redirect)**

Backend sẽ:

1. Set HttpOnly cookies với accessToken và refreshToken
2. Encode tokens thành base64
3. Redirect về frontend với authData trong query parameter

```
{FRONTEND_URL}/auth/callback?authData={base64_encoded_data}
```

**authData (sau khi decode base64) sẽ chứa:**

```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Response Headers (Set-Cookie)**:

```
Set-Cookie: accessToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict; Max-Age=3600
Set-Cookie: refreshToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; HttpOnly; Secure; SameSite=Strict; Max-Age=604800
```

**Error Responses**

- **400 Bad Request**: Google authentication failed

```json
{
  "success": false,
  "statusCode": 400,
  "message": "No user from Google",
  "error": "Bad Request",
  "timestamp": "2025-11-12T10:00:00.000Z",
  "path": "/auth/google/callback"
}
```

- **401 Unauthorized**: Account bị vô hiệu hóa

```json
{
  "success": false,
  "statusCode": 401,
  "message": "Account has been disabled",
  "error": "Unauthorized",
  "timestamp": "2025-11-12T10:00:00.000Z",
  "path": "/auth/google/callback"
}
```

---

## Frontend Integration

### Handling the Callback

Frontend cần xử lý authData từ query parameter:

```javascript
// In your /auth/callback page
const urlParams = new URLSearchParams(window.location.search);
const authData = urlParams.get('authData');

if (authData) {
  try {
    // Decode base64 data
    const decodedData = JSON.parse(atob(authData));

    // Extract tokens
    const { accessToken, refreshToken } = decodedData;

    // Store in localStorage (optional - cookies already set)
    localStorage.setItem('accessToken', accessToken);
    localStorage.setItem('refreshToken', refreshToken);

    // Redirect to dashboard or home page
    window.location.href = '/dashboard';
  } catch (error) {
    console.error('Failed to process auth data:', error);
    // Handle error - redirect to login
  }
}
```

### Using the Tokens

**Option 1: Use Cookies (Recommended for web)**

```javascript
// Cookies are automatically sent with requests
fetch('/api/users/me', {
  credentials: 'include', // Include cookies
});
```

**Option 2: Use Authorization Header (Mobile/API)**

```javascript
// Use tokens from localStorage
const accessToken = localStorage.getItem('accessToken');

fetch('/api/users/me', {
  headers: {
    Authorization: `Bearer ${accessToken}`,
  },
});
```

---

## Google OAuth Flow Details

### 1. User Scenarios

#### Scenario A: New User (First Time Login)

1. User clicks "Login with Google"
2. Google authentication successful
3. Backend creates new user with:
   - `email`: From Google
   - `googleId`: Google user ID
   - `fullName`: firstName + lastName from Google
   - `avatar`: Google profile picture
   - `isEmailVerified`: true (Google accounts are pre-verified)
   - `password`: null (no password for OAuth-only accounts)
4. Backend generates tokens and creates session
5. Redirect to frontend with authData

#### Scenario B: Existing Email User (Link Google)

1. User registered with email/password previously
2. User clicks "Login with Google" using same email
3. Backend finds existing user by email
4. Backend updates user with:
   - `googleId`: Links Google account
   - `avatar`: Updates if user doesn't have one
   - `isEmailVerified`: Set to true
5. User can now login with both email/password AND Google

#### Scenario C: Returning Google User

1. User logged in with Google before
2. Backend finds user by `googleId`
3. Generate tokens and create session
4. Redirect to frontend

### 2. Session Management

- Google login creates a new session
- Device info is automatically captured (browser, OS, IP)
- Session limit applies (default: 5 concurrent sessions)
- Oldest session removed if limit exceeded

---

## Common Errors

### Invalid Client ID

**Error**: `redirect_uri_mismatch`

**Cause**: Redirect URI không match với Google Console config

**Solution**: Kiểm tra lại `GOOGLE_CALLBACK_URL` và Google Console settings

### User Cancelled

**Scenario**: User từ chối cấp quyền trên Google consent screen

**Solution**: User sẽ được redirect về trang login, không có authData

### Account Disabled

**Response**:

```json
{
  "success": false,
  "statusCode": 401,
  "message": "Account has been disabled",
  "error": "Unauthorized",
  "timestamp": "2025-11-12T10:00:00.000Z",
  "path": "/auth/google/callback"
}
```

**Solution**: Contact admin để kích hoạt lại tài khoản
